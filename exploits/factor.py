import requests
import sys
import math

# Vulnerability 1: Generated keys can be fermat factored
# This means that the prime factors p and q are very close together.
# Therefore, we can search near the sqrt for the factors (do it smart)
# We can write N = p*q as N = (u - w)*(u + w) = u**2 - w**2
# To factor N, we try some values for u, for which we can check if w**2 = u**2 - N is a square number
# If it is, then we have found u and w and can compute the two factors
[n, e] = requests.get('http://localhost:5000/pubkey/' + sys.argv[1]).json()
n = int(n, 16)
e = int(e, 16)
u = math.isqrt(n) + 1
for i in range(1000):
    w = math.isqrt(u**2 - n)
    if u**2 - w**2 == n:
        p = u - w
        q = u + w
        break
else:
    print("Failed to fermat factor modulus")
    sys.exit(1)

phi = (p - 1) * (q - 1)
d = pow(e, -1, phi)
for msg in requests.get('http://localhost:5000/inbox/' + sys.argv[1]).json():
    print(pow(int(msg, 16), d, n).to_bytes(1024, byteorder='big').strip(b'\x00').decode() + "Q")
